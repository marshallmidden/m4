#!/bin/bash -e
#-----------------------------------------------------------------------------
/bin/date '+%Y-%m-%d_%H-%M-%S'
#-----------------------------------------------------------------------------
# Get username, password, parsec_IPADDRESS.
source ENV
#-----------------------------------------------------------------------------
# Command that handles projects/jobs through the REST interface.
CMD="./m4.py"
#=============================================================================
# Abbreviated name for each source storage.
SOURCEABR=(w2019 \
	   w2016 \
	   w2012 \
	   w2008 \
	   na116 \
	   na103 \
	   is100)
# . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
# Source IP addresses.
SOURCEIPS=(172.22.12.112 \
	   172.22.12.144 \
	   172.22.12.143 \
	   172.22.12.140 \
	   172.22.14.116 \
	   172.22.15.103 \
	   172.22.13.100)
# . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
# Source share names.
SOURCESHR=(m4-v1 \
	   m4-v1 \
	   m4-v1 \
	   m4-v1 \
	   cifs_v1 \
	   m4_smb_v1 \
	   m4_v1)
# . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
# Source SMB version.
SOURCEVER=(default \
	   default \
	   default \
	   default \
	   1.0 \
	   default \
	   default)
#----------------------------------------------------------------------------
# Abbreviated name for each destination storage.
DESTINABR=(na116 \
	   w2019 \
	   w2016 \
	   w2012 \
	   na103 \
	   is100 \
	   w2008)
# . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
# Destination IP addresses.
DESTINIPS=(172.22.14.116 \
	   172.22.12.112 \
	   172.22.12.144 \
	   172.22.12.143 \
	   172.22.15.103 \
	   172.22.13.100 \
	   172.22.12.140)
# . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
# Destination share names.
DESTINSHR=(cifs_v2 \
	   m4-v2 \
	   m4-v2 \
	   m4-v2 \
	   m4_smb_v2 \
	   m4_v2 \
	   m4-v2)
# . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
# Destination SMB version.
DESTINVER=(1.0 \
	   default \
	   default \
	   default \
	   default \
	   default \
	   default)
# . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
#+ for i in {0..6}; do
#+     echo "${SOURCEABR[$i]} ${SOURCEIPS[$i]} ${SOURCESHR[$i]} ${SOURCEVER[$i]}  -> ${DESTINABR[$i]} ${DESTINIPS[$i]} ${DESTINSHR[$i]} ${DESTINVER[$i]}"
#+ done
let i=${#SOURCEABR[@]} || true
if [ "${#SOURCEIPS[@]}" != $i -o "${#SOURCESHR[@]}" != $i -o	\
     "${#SOURCEVER[@]}" != $i -o				\
     "${#DESTINABR[@]}" != $i -o "${#DESTINIPS[@]}" != $i -o	\
     "${#DESTINSHR[@]}" != $i -o "${#DESTINVER[@]}" != $i ]; then
    echo "ERROR - arrays are not of the same length, please fix."
    echo SOURCEABR="${#SOURCEABR[@]}" SOURCEIPS="${#SOURCEIPS[@]}" SOURCESHR="${#SOURCESHR[@]}" SOURCEVER="${#SOURCEVER[@]}"
    echo DESTINABR="${#DESTINABR[@]}" DESTINIPS="${#DESTINIPS[@]}" DESTINSHR="${#DESTINSHR[@]}" DESTINVER="${#DESTINVER[@]}"
    exit 1
fi

#=============================================================================
echo 'Start Verify for the jobs.'
# Get the job id's.
J=`${CMD} job list | grep '^ *[0-9][0-9]*: ' | sed -e 's;^ *\([0-9]*\):.*$;\1;'`
if [ "$J" != '' ]; then
    echo "J=${J}"
    # Start the verify for the jobs.
    VERIFY=`${CMD} job verify ${J}`
    echo "VERIFY=${VERIFY}"
fi
echo 'Started verify for the jobs.'
#-----------------------------------------------------------------------------
# 8
echo "Sleep five seconds to let scheduler do its business."
sleep 5
date
echo 'Wait til all jobs finished.'
set +e					# No longer have exit status exit script.
c=0
while [ "$c" != '' ]; do
    sleep 0.25
    c=`ps -C pxlhr -o pid=`
done
echo 'pxlhr appears to be done.'
#-----------------------------------------------------------------------------
# 9
echo "Sleep five seconds to let things settle down."
sleep 5
#-----------------------------------------------------------------------------
echo "Done with $0"
/bin/date '+%Y-%m-%d_%H-%M-%S'
#-----------------------------------------------------------------------------
exit 0
#-----------------------------------------------------------------------------
