#!/bin/bash -epx
#-----------------------------------------------------------------------------
source 172.22.14.10/ENV
#-----------------------------------------------------------------------------
#-- NJOBS=2
#-- JOBS='1055 1056'
NJOBS=8
JOBS='1057 1058 1059 1060 1061 1062 1063 1064'
#-----------------------------------------------------------------------------
# a) loop ...
#    b) delete all files on destination.
#    c) Run the 4 jobs till they are finished.
# d) end loop.
#-----------------------------------------------------------------------------
systemctl unmask smb
systemctl enable smb
systemctl start smb
#-----------------------------------------------------------------------------
DOMAIN_NETAPP='AD'
USER_NETAPP='Parsec.Backup'
PW_NETAPP='Cobra!Indigo'
FIRST_NETAPP='mount -t cifs '
SECOND_NETAPP='//172.22.13.100/'
THIRD_NETAPP='/mnt/netapp/'
FOURTH_NETAPP="-o rw,username=${USER_NETAPP},password=${PW_NETAPP},domain=${DOMAIN_NETAPP},nosuid,nodev,noexec,vers=3.1.1,cache=none,uid=0,noforceuid,gid=0,noforcegid,file_mode=0755,dir_mode=0755,soft,nounix,noperm,rsize=4194304,wsize=4194304,bsize=1048576,echo_interval=60,actimeo=1"
#-----------------------------------------------------------------------------
#-- DOMAIN_PURE='KRB.TEST.LAB'
DOMAIN_PURE='krb'
#-- USER_PURE='Parsec.Backup'
USER_PURE='m4a'
PW_PURE='AlphaDog123!'
FIRST_PURE='mount -t cifs '
SECOND_PURE='//172.22.205.65/'
THIRD_PURE='/mnt/pure/'
FOURTH_PURE="-o rw,username=${USER_PURE},password=${PW_PURE},domain=${DOMAIN_PURE},nosuid,nodev,noexec,vers=3.1.1,cache=none,uid=0,noforceuid,gid=0,noforcegid,file_mode=0755,dir_mode=0755,soft,nounix,noperm,rsize=4194304,wsize=4194304,bsize=1048576,echo_interval=60,actimeo=1"

#??         "-o rw,username=m4a,password=AlphaDog123!,domain=krb,nosuid,nodev,noexec,vers=3.1.1,cache=none,uid=0,noforceuid,gid=0,noforcegid,file_mode=0755,dir_mode=0755,soft,nounix,noperm,rsize=4194304,wsize=4194304,bsize=1048576,echo_interval=60,actimeo=1"
#--         '-o rw,username=m4a,password=AlphaDog123!,domain=krb,nosuid,nodev,noexec,vers=3.1.1,cache=none,uid=0,noforceuid,gid=0,noforcegid,file_mode=0755,dir_mode=0755,soft,nounix,noperm,rsize=4194304,wsize=4194304,bsize=1048576,echo_interval=60,actimeo=1'
#--         '-o rw,nosuid,nodev,noexec,vers=3.1.1,cache=none,password=AlphaDog123!,username=m4a,uid=0,noforceuid,gid=0,noforcegid,file_mode=0755,dir_mode=0755,soft,nounix,noperm,rsize=4194304,wsize=4194304,bsize=1048576,echo_interval=60,actimeo=1,domain=krb'
#-----------------------------------------------------------------------------
wait_for_jobs () {
    while [ 0 ]; do
	N=`./m4.py --one-line jobs list | grep -c "'STOPPED'"` || true
	if [ $N -eq ${NJOBS} ]; then
	    break
	fi
	sleep 1
    done
}
#-----------------------------------------------------------------------------
delete_lhr_files () {
    A="$1"
    while [ \! -z "$A" ]; do
        echo "A=$A"
        (cd /media/parsecdata/lhr/ && rm -rf ${A}/* ) || true
        shift
        A="$1"
    done
}
#-----------------------------------------------------------------------------
delete_all_files_NETAPP () {
    A="$1"
    mkdir -p ${THIRD_NETAPP}${A}
    ${FIRST_NETAPP} ${SECOND_NETAPP}${A} ${THIRD_NETAPP}${A} ${FOURTH_NETAPP}
    (cd ${THIRD_NETAPP}${A} && rm -rf *) || true
    umount ${THIRD_NETAPP}${A}
}
#-----------------------------------------------------------------------------
delete_all_files_PURE () {
    A="$1"
    mkdir -p ${THIRD_PURE}${A}
    ${FIRST_PURE} ${SECOND_PURE}${A} ${THIRD_PURE}${A} ${FOURTH_PURE}
}
#--    (cd ${THIRD_PURE}${A} && rm -rf *) || true
#--    umount ${THIRD_PURE}${A}
#-----------------------------------------------------------------------------
#--     delete_all_files_NETAPP m4_v1
#--     delete_all_files_NETAPP m4_v2
set +x
while [ 0 ] ; do
    delete_all_files_PURE m4_src01
    delete_all_files_PURE m4_src02
    delete_all_files_PURE m4_src03
    delete_all_files_PURE m4_src04
    delete_all_files_PURE m4_dest01
    delete_all_files_PURE m4_dest02
    delete_all_files_PURE m4_dest03
    delete_all_files_PURE m4_dest04
    break
    delete_lhr_files ${JOBS}
    ./m4.py jobs run ${JOBS}
    ./m4.py jobs list --one-line
    sleep 1
    wait_for_jobs
    sleep 60
done
echo done
#-----------------------------------------------------------------------------
