#!/bin/bash -ex
#-----------------------------------------------------------------------------
echo entering 14-rpm
BINARIES="/home/m4/new-a"
#-----------------------------------------------------------------------------
prepath () {
    case ":$PATH:" in
      *":$1:"*) :;;         # in the middle
      "$1:"*) :;;           # at the end
      *":$1") :;;           # at the beginning
      "$1") :;;             # if only one
      *) PATH=$1:$PATH;;
    esac
}
prepath ${BINARIES}/bin
#-----------------------------------------------------------------------------
mkdir -p ${BINARIES}
J="-j 200"
#-----------------------------------------------------------------------------
yum install -y popt-devel-1.13-16.el7.x86_64
yum install -y lua.x86_64
#-----------------------------------------------------------------------------
if [ ! -d rpm-4.16.1.2 ]; then
    if [ ! -f rpm-4.16.1.2.tar.gz ]; then
	wget -N http://ftp.rpm.org/releases/rpm-4.16.x/rpm-4.16.1.2.tar.bz2
    fi
    tar xf rpm-4.16.1.2.tar.bz2
    patch -p0 < RPM.configure.patch
fi
#-----------------------------------------------------------------------------
if [ ! -d db-4.5.20 ]; then
    if [ ! -f db-4.5.20.tar.gz ]; then
	wget -N http://download.oracle.com/berkeley-db/db-4.5.20.tar.gz
    fi
    tar xf db-4.5.20.tar.gz
fi
( cd rpm-4.16.1.2/ && ln -sf ../db-4.5.20 db )
#-----------------------------------------------------------------------------
#-----------------------------------------------------------------------------
cd rpm-4.16.1.2/
#-----------------------------------------------------------------------------
./configure --prefix=${BINARIES} CFLAGS='-fPIE -fPIC' LUA_LIBS=/usr/local/lib/liblua.a LIBS=-lm 1>&2
#-----------------------------------------------------------------------------
make ${J}
#-----------------------------------------------------------------------------
make install
#-----------------------------------------------------------------------------
make clean || true
make distclean || true
#-----------------------------------------------------------------------------
echo exiting 14-rpm
exit 0
#-----------------------------------------------------------------------------
