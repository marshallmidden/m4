#!/usr/bin/perl -w

use strict;
use warnings;
#-----------------------------------------------------------------------------
my $W = `pwd`;
chomp($W);
my $DIRnew = 'linux';

my @args;
if (scalar @ARGV == 0)
{
    my $args = `egrep -v '^#|^[ 	]*\$' 99.patch-work-on`;
    @args = split(/\n/, $args);
    #--     foreach my $i (@args)
}
else
{
    @args = @ARGV;
}

#-----------------------------------------------------------------------------
sub dry_run($)
{
    my $f = $_[0];
    print STDERR "------------------------------------------------------------------------------\n";
    print STDERR "patch dry-run: $f\n";
    my $A = `patch -d ${DIRnew} -p1 -i ${W}/${f} --dry-run -f`;
    my @a = split(/\n/, $A);
    my $failure = 0;

    foreach my $j (@a)
    {
	if ($j !~ /^checking/)
	{
	    $failure = 1;
	}
	print STDERR "${j}\n";
    }
    if ($failure != 0)
    {
	exit 1;
    }
}   # End of dry-run

#-----------------------------------------------------------------------------
sub patchit($)
{
    my $f = $_[0];
    print STDERR "------------------------------------------------------------------------------\n";
    print STDERR "patch: $f\n";
    my $A = `patch -d ${DIRnew} -p1 -i ${W}/${f} -f`;
    my @a = split(/\n/, $A);
    my $failure = 0;

    foreach my $j (@a)
    {
	if ($j !~ /^checking/)
	{
	    $failure = 1;
	}
	print STDERR "${j}\n";
    }
    if ($failure != 0)
    {
	exit 1;
    }
}   # End of patchit

#-----------------------------------------------------------------------------
sub undry_run($)
{
    my $f = $_[0];
    print STDERR "------------------------------------------------------------------------------\n";
    print STDERR "unpatch: $f\n";
    my $A = `patch -R -d ${DIRnew} -p1 -i ${W}/$f --dry-run -f`;
    my @a = split(/\n/, $A);
    my $failure = 0;

    foreach my $j (@a)
    {
	if ($j !~ /^checking/)
	{
	    $failure = 1;
	}
	print STDERR "${j}\n";
    }
    if ($failure != 0)
    {
	exit 1;
    }
}   # End of patchit

#-----------------------------------------------------------------------------
foreach my $i (@args)
{
    dry_run($i);
    patchit($i);
    undry_run($i);
}

exit 0;
# End of file 01.DRY-RUN
